<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –ø–æ–ª–Ω–æ–≥–æ flow –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .step { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üß™ –¢–µ—Å—Ç –ø–æ–ª–Ω–æ–≥–æ flow –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏</h1>
    
    <div class="step info">
        <h3>–®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è</h3>
        <p>–ü—Ä–æ–≤–µ—Ä–∏–º, –µ—Å—Ç—å –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ localStorage –∏ –µ–≥–æ —Å—Ç–∞—Ç—É—Å –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏</p>
        <button onclick="checkCurrentState()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ</button>
        <pre id="current-state">–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏</pre>
    </div>

    <div class="step info">
        <h3>–®–∞–≥ 2: –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
        <p>–°–æ–∑–¥–∞–¥–∏–º –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</p>
        <button onclick="createNewUser()">–°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
        <pre id="create-result">–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è</pre>
    </div>

    <div class="step info">
        <h3>–®–∞–≥ 3: –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è email</h3>
        <p>–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–µ–º –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é —Å –ø–æ–ª—É—á–µ–Ω–Ω—ã–º —Ç–æ–∫–µ–Ω–æ–º</p>
        <input type="text" id="verification-token" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Ç–æ–∫–µ–Ω –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏" style="width: 400px;">
        <button onclick="verifyEmail()">–í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å email</button>
        <pre id="verify-result">–í—Å—Ç–∞–≤—å—Ç–µ —Ç–æ–∫–µ–Ω –∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É</pre>
    </div>

    <div class="step info">
        <h3>–®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è</h3>
        <p>–ü—Ä–æ–≤–µ—Ä–∏–º, –∏–∑–º–µ–Ω–∏–ª—Å—è –ª–∏ —Å—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</p>
        <button onclick="checkUpdatedState()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ</button>
        <pre id="updated-state">–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏</pre>
    </div>

    <div class="step info">
        <h3>–®–∞–≥ 5: –¢–µ—Å—Ç –≤—Ö–æ–¥–∞ –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h3>
        <p>–ü–æ–ø—Ä–æ–±—É–µ–º –≤–æ–π—Ç–∏ –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</p>
        <button onclick="testCabinetAccess()">–¢–µ—Å—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–±–∏–Ω–µ—Ç—É</button>
        <pre id="cabinet-result">–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è —Ç–µ—Å—Ç–∞</pre>
    </div>

    <script>
        const API_ENDPOINT = 'https://portaldata.ru/api/v1';

        // –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        async function checkCurrentState() {
            const result = {
                localStorage: {
                    token: localStorage.getItem('token'),
                    user: localStorage.getItem('user')
                },
                window: {
                    AUTH_TOKEN: window.AUTH_TOKEN,
                    user: window.user
                }
            };
            
            document.getElementById('current-state').textContent = JSON.stringify(result, null, 2);
        }

        // –®–∞–≥ 2: –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function createNewUser() {
            try {
                const email = `test_verification_${Date.now()}@example.com`;
                const userData = {
                    email: email,
                    password: 'test123456',
                    name: 'Test Verification User',
                    inn: '1234567890'
                };

                const response = await fetch(`${API_ENDPOINT}/user/registration`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(userData)
                });

                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('create-result').textContent = 
                        `‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω!\nEmail: ${email}\nID: ${data.item.id}\n\n–¢–µ–ø–µ—Ä—å –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—á—Ç—É –∏ –≤—Å—Ç–∞–≤—å—Ç–µ —Ç–æ–∫–µ–Ω –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –≤ –ø–æ–ª–µ –≤—ã—à–µ.`;
                } else {
                    document.getElementById('create-result').textContent = 
                        `‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è: ${JSON.stringify(data, null, 2)}`;
                }
            } catch (error) {
                document.getElementById('create-result').textContent = 
                    `üö® –û—à–∏–±–∫–∞: ${error.message}`;
            }
        }

        // –®–∞–≥ 3: –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è email
        async function verifyEmail() {
            const token = document.getElementById('verification-token').value.trim();
            if (!token) {
                document.getElementById('verify-result').textContent = '‚ùå –í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏';
                return;
            }

            try {
                const response = await fetch(`${API_ENDPOINT}/user/verify`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ token })
                });

                const data = await response.json();
                
                if (data.code === 200) {
                    document.getElementById('verify-result').textContent = 
                        `‚úÖ Email —É—Å–ø–µ—à–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω!\n–û—Ç–≤–µ—Ç: ${JSON.stringify(data, null, 2)}`;
                } else {
                    document.getElementById('verify-result').textContent = 
                        `‚ùå –û—à–∏–±–∫–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏: ${JSON.stringify(data, null, 2)}`;
                }
            } catch (error) {
                document.getElementById('verify-result').textContent = 
                    `üö® –û—à–∏–±–∫–∞: ${error.message}`;
            }
        }

        // –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        async function checkUpdatedState() {
            try {
                // –ü–æ–ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const response = await fetch(`${API_ENDPOINT}/user/data`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                const data = await response.json();
                
                const result = {
                    localStorage: {
                        token: localStorage.getItem('token'),
                        user: localStorage.getItem('user')
                    },
                    window: {
                        AUTH_TOKEN: window.AUTH_TOKEN,
                        user: window.user
                    },
                    apiResponse: data
                };
                
                document.getElementById('updated-state').textContent = JSON.stringify(result, null, 2);
            } catch (error) {
                document.getElementById('updated-state').textContent = 
                    `üö® –û—à–∏–±–∫–∞: ${error.message}`;
            }
        }

        // –®–∞–≥ 5: –¢–µ—Å—Ç –≤—Ö–æ–¥–∞ –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç
        async function testCabinetAccess() {
            try {
                // –ü–æ–ø—Ä–æ–±—É–µ–º –≤–æ–π—Ç–∏ —Å —Å–æ–∑–¥–∞–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
                const email = document.getElementById('verification-token').value.trim() ? 
                    'test_verification@example.com' : 'test_debug@example.com';
                
                const response = await fetch(`${API_ENDPOINT}/authentication_token`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: email,
                        password: 'test123456'
                    })
                });

                const data = await response.json();
                
                if (data.token) {
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω
                    localStorage.setItem('token', data.token);
                    window.AUTH_TOKEN = data.token;
                    
                    // –¢–µ–ø–µ—Ä—å –ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    const userResponse = await fetch(`${API_ENDPOINT}/user/data`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${data.token}`
                        }
                    });

                    const userData = await userResponse.json();
                    
                    const result = {
                        login: data,
                        userData: userData,
                        localStorage: {
                            token: localStorage.getItem('token')
                        }
                    };
                    
                    document.getElementById('cabinet-result').textContent = 
                        `‚úÖ –í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω!\n${JSON.stringify(result, null, 2)}`;
                } else {
                    document.getElementById('cabinet-result').textContent = 
                        `‚ùå –û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ${JSON.stringify(data, null, 2)}`;
                }
            } catch (error) {
                document.getElementById('cabinet-result').textContent = 
                    `üö® –û—à–∏–±–∫–∞: ${error.message}`;
            }
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', checkCurrentState);
    </script>
</body>
</html>
